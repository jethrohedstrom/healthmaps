---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

const practitioners = (await getCollection('practitioners')).sort((a, b) => (a.data.order ?? 99) - (b.data.order ?? 99));
---
<BaseLayout
  title="Who should I see?"
  description="Compare mental health professionals in Australia, including psychologists, psychiatrists, counsellors, social workers, and more. Understand costs, Medicare rebates, and referral requirements."
>
  <!-- Hero -->
  <section class="bg-white">
    <div class="max-w-[960px] mx-auto px-4 pt-16 md:pt-20 pb-12 md:pb-16">
      <div class="max-w-[720px]">
        <h1 class="text-[2.25rem] md:text-[2.5rem] font-bold text-slate-800 mb-8 tracking-[-0.01em]">Who should I see?</h1>
        <div class="space-y-5 text-lg leading-relaxed text-body">
          <p>If you're reading this, you or someone you care about could probably use some professional support.</p>
          <p>But now you're staring at a confusing list of titles. Psychologist, psychiatrist, counsellor, social worker, occupational therapist. What's the difference? Does it matter?</p>
          <details class="accordion-item">
            <summary class="text-lg font-semibold text-slate-800">Does it actually matter?</summary>
            <div class="accordion-content space-y-5 text-lg leading-relaxed text-body">
              <p>Sometimes it matters less than you'd think. Finding someone you trust and can talk to is often the most important thing. But there are real differences worth knowing about. Some professionals can prescribe medication and others can't, and some titles in Australia don't require any formal training at all.</p>
              <p>If this all feels too hard, <strong class="text-heading font-semibold">just see your GP.</strong> They can assess what's going on, explain your options, and refer you to the right person. If you do want to understand the differences first, the rest of this page breaks it all down.</p>
            </div>
          </details>
        </div>
      </div>
    </div>
  </section>

  <!-- GP callout -->
  <section class="bg-white">
    <div class="max-w-[960px] mx-auto px-4 pb-16 md:pb-20">
      <div class="bg-icon-bg rounded-xl p-8 md:p-10">
        <div class="flex items-start gap-4">
          <div class="w-10 h-10 rounded-lg bg-white flex items-center justify-center flex-shrink-0">
            <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 0a6.01 6.01 0 0 0 1.5-.189m-1.5.189a6.01 6.01 0 0 1-1.5-.189m3.75 7.478a12.06 12.06 0 0 1-4.5 0m3.75 2.383a14.406 14.406 0 0 1-3 0M14.25 18v-.192c0-.983.658-1.823 1.508-2.316a7.5 7.5 0 1 0-7.517 0c.85.493 1.509 1.333 1.509 2.316V18" />
            </svg>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-heading mb-2">Not sure where to start? See your GP.</h3>
            <p class="text-body text-sm leading-relaxed">
              Your GP can assess your situation, create a Mental Health Care Plan, and refer you to the right professional. This is the most common first step, and it unlocks Medicare rebates.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Practitioner summary cards -->
  <section class="bg-gray-50">
    <div class="max-w-[960px] mx-auto px-4 py-16 md:py-20">
      <details class="accordion-item">
        <summary>
          <h2 class="text-[1.5rem] md:text-[2rem] font-bold text-slate-800 tracking-[-0.01em] inline">Compare practitioners</h2>
        </summary>
        <div class="accordion-content">
          <p class="text-gray-500 mb-6">What each type costs and when to see them.</p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {practitioners.map(async (p) => {
              const { Content } = await render(p);
              return (
                <details id={p.id} class="practitioner-card bg-white rounded-xl p-6 md:p-8 shadow-sm scroll-mt-24">
                  <summary>
                    <h3 class="text-lg font-semibold text-heading mb-3">{p.data.title}</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 gap-y-2">
                      <div>
                        <div class="text-xs uppercase tracking-wide text-gray-400 mb-0.5">Typical cost</div>
                        <div class="text-sm font-semibold text-heading">{p.data.cost.replace(' per session', '')}</div>
                      </div>
                      <div>
                        <div class="text-xs uppercase tracking-wide text-gray-400 mb-0.5">Medicare rebate</div>
                        <div class="text-sm font-semibold text-heading">{p.data.rebate}</div>
                      </div>
                      <div>
                        <div class="text-xs uppercase tracking-wide text-gray-400 mb-0.5">Referral needed</div>
                        {p.data.referralRequired ? (
                          <div class="text-sm font-semibold text-brand-orange">Yes (GP referral)</div>
                        ) : (
                          <div class="text-sm font-semibold text-brand-green">No, book directly</div>
                        )}
                      </div>
                    </div>
                  </summary>
                  <div class="border-t border-gray-100 mt-4 pt-4 prose prose-sm max-w-none text-gray-700">
                    <Content />
                  </div>
                </details>
              );
            })}
          </div>

          <details class="accordion-item mt-8 scroll-mt-24">
            <summary class="text-lg font-semibold text-slate-800">Compare at a glance</summary>
            <div class="accordion-content">
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left border-collapse">
                  <thead>
                    <tr class="border-b-2 border-gray-300">
                      <th class="py-3 px-4 font-semibold text-slate-800"></th>
                      <th class="py-3 px-4 font-semibold text-slate-800">Typical Cost</th>
                      <th class="py-3 px-4 font-semibold text-slate-800">Medicare Rebate</th>
                      <th class="py-3 px-4 font-semibold text-slate-800">Referral Needed?</th>
                    </tr>
                  </thead>
                  <tbody>
                    {practitioners.map((p, i) => (
                      <tr class:list={[i % 2 === 0 ? 'bg-white' : 'bg-gray-50', 'border-b border-gray-200']}>
                        <td class="py-3 px-4 font-semibold text-gray-700">{p.data.title}</td>
                        <td class="py-3 px-4 text-gray-500">{p.data.cost}</td>
                        <td class="py-3 px-4 text-gray-500">{p.data.rebate}</td>
                        <td class="py-3 px-4">
                          {p.data.referralRequired ? (
                            <span class="text-brand-orange font-medium">Yes</span>
                          ) : (
                            <span class="text-brand-green font-medium">No</span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </details>
        </div>
      </details>
    </div>
  </section>

  <!-- CTA -->
  <section class="bg-gray-50">
    <div class="max-w-[720px] mx-auto px-4 py-16 md:py-20 text-center">
      <h2 class="text-xl font-semibold text-slate-800 mb-3">Want to estimate your out-of-pocket costs?</h2>
      <a href="/calculator/" class="inline-block bg-primary text-heading px-10 py-4 rounded-xl font-semibold shadow-sm hover:bg-primary/90 transition-colors">
        Use the Cost Calculator
      </a>
    </div>
  </section>

  <!-- Auto-open accordion when navigating from decision helper -->
  <script>
    function openTargetAccordion() {
      const hash = window.location.hash;
      if (!hash) return;
      const target = document.querySelector(hash);
      if (target instanceof HTMLDetailsElement) {
        // Open ancestor <details> elements first (e.g. the parent "The details" accordion)
        let ancestor = target.parentElement;
        while (ancestor) {
          if (ancestor instanceof HTMLDetailsElement) {
            ancestor.open = true;
          }
          ancestor = ancestor.parentElement;
        }
        target.open = true;
      }
    }
    openTargetAccordion();
    window.addEventListener('hashchange', openTargetAccordion);

    // Expand practitioner card to full width when opened
    document.querySelectorAll<HTMLDetailsElement>('.practitioner-card').forEach(card => {
      card.addEventListener('toggle', () => {
        card.classList.toggle('md:col-span-2', card.open);
      });
    });

    // Also apply col-span if hash-opened on load
    const hashTarget = window.location.hash ? document.querySelector<HTMLDetailsElement>(window.location.hash) : null;
    if (hashTarget?.classList.contains('practitioner-card') && hashTarget.open) {
      hashTarget.classList.add('md:col-span-2');
    }
  </script>
</BaseLayout>
